<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' https://*.supabase.co; frame-ancestors 'none';">
    <meta name="robots" content="noindex, nofollow">
    <title>Cybersecurity Awareness Assessment - Secure Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Animated background */
        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0a0e27 0%, #1a1f3a 100%);
            overflow: hidden;
        }

        .bg-animation {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.5;
            animation: float 20s infinite ease-in-out;
        }

        .orb1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.8) 0%, transparent 70%);
            top: -200px;
            left: -200px;
            animation-delay: 0s;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(118, 75, 162, 0.8) 0%, transparent 70%);
            bottom: -100px;
            right: -100px;
            animation-delay: 5s;
        }

        .orb3 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(240, 147, 251, 0.8) 0%, transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(100px, -100px) scale(1.1);
            }
            50% {
                transform: translate(-100px, 100px) scale(0.9);
            }
            75% {
                transform: translate(50px, 50px) scale(1.05);
            }
        }

        /* Particles */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: particle-float 15s infinite linear;
        }

        @keyframes particle-float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Container styling */
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(200%);
            -webkit-backdrop-filter: blur(20px) saturate(200%);
            border-radius: 30px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.12),
                0 4px 6px rgba(0, 0, 0, 0.04),
                inset 0 -2px 0 0 rgba(0, 0, 0, 0.02);
            padding: 50px;
            max-width: 900px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: container-appear 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            animation: gradient-shift 3s ease-in-out infinite;
        }

        @keyframes container-appear {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes gradient-shift {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Page transitions */
        .page {
            display: none;
            animation: page-fade-in 0.6s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes page-fade-in {
            0% {
                opacity: 0;
                transform: translateX(20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Header styling */
        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: header-slide-down 0.8s ease-out 0.3s both;
        }

        @keyframes header-slide-down {
            0% {
                opacity: 0;
                transform: translateY(-30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            width: 100px;
            height: 100px;
            background: var(--primary-gradient);
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            font-size: 48px;
            color: white;
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            animation: logo-pulse 2s ease-in-out infinite;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05) rotate(5deg);
        }

        @keyframes logo-pulse {
            0%, 100% {
                box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 20px 50px rgba(102, 126, 234, 0.5);
            }
        }

        h1, h2 {
            color: #1a202c;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: text-shimmer 3s ease-in-out infinite;
        }

        @keyframes text-shimmer {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
        }

        h1 {
            font-size: 2.5rem;
        }

        h2 {
            font-size: 2rem;
        }

        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
            line-height: 1.6;
            animation: fade-in 1s ease-out 0.5s both;
        }

        @keyframes fade-in {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        /* Form styling */
        .form-group {
            margin-bottom: 25px;
            animation: form-slide-up 0.6s ease-out both;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-group:nth-child(4) { animation-delay: 0.4s; }
        .form-group:nth-child(5) { animation-delay: 0.5s; }
        .form-group:nth-child(6) { animation-delay: 0.6s; }

        @keyframes form-slide-up {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        label {
            display: block;
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
            position: relative;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 
                0 0 0 4px rgba(102, 126, 234, 0.1),
                0 4px 6px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        /* Button styling */
        .btn {
            padding: 16px 35px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Question styling */
        .question-container {
            margin: 35px 0;
            animation: question-appear 0.6s ease-out;
        }

        @keyframes question-appear {
            0% {
                opacity: 0;
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .question {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: #1e293b;
            line-height: 1.6;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .option {
            background: #f8fafc;
            border: 2px solid transparent;
            padding: 20px 25px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 1.05rem;
        }

        .option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
            transform: translateY(-50%);
        }

        .option:hover {
            transform: translateX(5px);
            background: #f1f5f9;
            border-color: #e2e8f0;
        }

        .option:hover::after {
            left: 100%;
        }

        .option.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-color: #667eea;
            transform: translateX(10px);
        }

        /* Progress bar */
        .progress-container {
            margin: 30px 0;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 10px;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            background: var(--primary-gradient);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 50px;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: progress-shimmer 2s linear infinite;
        }

        @keyframes progress-shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Video player styling */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            margin: 35px 0;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Results styling */
        .result-card {
            text-align: center;
            padding: 50px;
            animation: result-zoom-in 0.8s ease-out;
        }

        @keyframes result-zoom-in {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .score-display {
            font-size: 5rem;
            font-weight: 800;
            margin: 30px 0;
            position: relative;
            display: inline-block;
        }

        .score-pass {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: score-bounce 0.6s ease-out;
        }

        .score-fail {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: score-shake 0.5s ease-out;
        }

        @keyframes score-bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }

        @keyframes score-shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            75% {
                transform: translateX(10px);
            }
        }

        /* Alert styling */
        .alert {
            padding: 18px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            animation: alert-slide-in 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes alert-slide-in {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Security warning */
        .security-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
            z-index: 10000;
            font-weight: 600;
            animation: warning-slide-down 0.3s ease-out;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
        }

        @keyframes warning-slide-down {
            0% {
                transform: translateY(-100%);
            }
            100% {
                transform: translateY(0);
            }
        }

        /* Loading state */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading.show {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loader-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #667eea;
            animation: loader-spin 1s linear infinite;
        }

        .loader-ring:nth-child(2) {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            border-top-color: #764ba2;
            animation-delay: 0.2s;
        }

        .loader-ring:nth-child(3) {
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            border-top-color: #f093fb;
            animation-delay: 0.4s;
        }

        @keyframes loader-spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Certificate styling */
        .certificate-preview {
            margin: 40px 0;
            text-align: center;
            animation: certificate-appear 1s ease-out;
        }

        @keyframes certificate-appear {
            0% {
                opacity: 0;
                transform: scale(0.9) rotateX(10deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotateX(0);
            }
        }

        #certificateCanvas {
            max-width: 100%;
            height: auto;
            border: 3px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.1),
                0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        #certificateCanvas:hover {
            transform: scale(1.02);
            box-shadow: 
                0 40px 80px rgba(0, 0, 0, 0.15),
                0 8px 12px rgba(0, 0, 0, 0.08);
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .question {
                font-size: 1.1rem;
            }
            
            .option {
                padding: 15px 20px;
                font-size: 1rem;
            }
            
            .score-display {
                font-size: 3.5rem;
            }
        }

        /* Disable text selection during exam */
        .exam-active {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Anti-screenshot overlay */
        .screenshot-protection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0, 0, 0, 0.01) 10px,
                rgba(0, 0, 0, 0.01) 20px
            );
        }
    </style>
</head>
<body class="exam-active">
    <div class="bg-container">
        <div class="bg-animation">
            <div class="gradient-orb orb1"></div>
            <div class="gradient-orb orb2"></div>
            <div class="gradient-orb orb3"></div>
        </div>
        <div class="particles" id="particlesContainer"></div>
    </div>

    <div class="screenshot-protection"></div>
    
    <div class="security-warning" id="securityWarning">
        ⚠️ Security Alert: Suspicious activity detected
    </div>

    <div class="loading" id="loading">
        <div class="loader">
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
            <div class="loader-ring"></div>
        </div>
    </div>

    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="page active">
            <div class="header">
                <div class="logo">🛡️</div>
                <h1>Cybersecurity Awareness Training</h1>
                <p class="subtitle">Register to begin your mandatory security assessment</p>
            </div>

            <div class="alert alert-error" id="regError"></div>
            <div class="alert alert-success" id="regSuccess"></div>

            <form id="registrationForm" autocomplete="off">
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" required autocomplete="off" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" required autocomplete="off" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="employeeId">Employee ID *</label>
                    <input type="text" id="employeeId" required placeholder="e.g., EMP12345" autocomplete="off" maxlength="20">
                </div>

                <div class="form-group">
                    <label for="designation">Designation *</label>
                    <select id="designation" required onchange="handleDesignationChange()">
                        <option value="">Select Designation</option>
                        <!-- Options will be loaded from database -->
                    </select>
                </div>

                <div class="form-group" id="otherDesignationGroup" style="display: none;">
                    <label for="otherDesignation">Please specify designation *</label>
                    <input type="text" id="otherDesignation" placeholder="Enter your designation" maxlength="50">
                </div>

                <div class="form-group">
                    <label for="email">Email Address *</label>
                    <input type="email" id="email" required placeholder="name@organization.ae" autocomplete="off" maxlength="100">
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 30px;">
                    <span>Begin Assessment</span>
                    <span>→</span>
                </button>
            </form>
        </div>

        <!-- Pre-Assessment Page -->
        <div id="preAssessmentPage" class="page">
            <div class="header">
                <h2>Pre-Assessment Test</h2>
                <p class="subtitle">Test your current cybersecurity knowledge</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="preProgress"></div>
                </div>
            </div>

            <div id="preQuestionContainer">
                <!-- Questions will be dynamically inserted here -->
            </div>

            <div class="navigation">
                <button class="btn btn-primary" id="prePrevBtn" onclick="preAssessment.previousQuestion()" disabled>
                    ← Previous
                </button>
                <button class="btn btn-primary" id="preNextBtn" onclick="preAssessment.nextQuestion()">
                    Next →
                </button>
            </div>
        </div>

        <!-- Video Training Page -->
        <div id="videoPage" class="page">
            <div class="header">
                <h2>Cybersecurity Training Video</h2>
                <p class="subtitle">Watch the complete video to proceed to the post-assessment</p>
            </div>

            <div class="video-container">
                <video id="trainingVideo" controls controlsList="nodownload" disablePictureInPicture>
                    <source src="https://youtu.be/BGMG7AIKNRg" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="videoProgress"></div>
                </div>
                <p style="text-align: center; margin-top: 10px; color: #64748b;">
                    Progress: <span id="videoPercent">0</span>% - Must watch 90% to continue
                </p>
            </div>

            <button class="btn btn-primary" id="continueToPost" disabled style="width: 100%; margin-top: 30px;">
                Continue to Post-Assessment →
            </button>
        </div>

        <!-- Post-Assessment Page -->
        <div id="postAssessmentPage" class="page">
            <div class="header">
                <h2>Post-Assessment Test</h2>
                <p class="subtitle">Test your knowledge after the training</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="postProgress"></div>
                </div>
            </div>

            <div id="postQuestionContainer">
                <!-- Questions will be dynamically inserted here -->
            </div>

            <div class="navigation">
                <button class="btn btn-primary" id="postPrevBtn" onclick="postAssessment.previousQuestion()" disabled>
                    ← Previous
                </button>
                <button class="btn btn-primary" id="postNextBtn" onclick="postAssessment.nextQuestion()">
                    Next →
                </button>
            </div>
        </div>

        <!-- Results Page -->
        <div id="resultsPage" class="page">
            <div class="result-card">
                <h2>Assessment Complete!</h2>
                
                <div class="score-display" id="scoreDisplay">0/10</div>
                
                <p class="result-message" id="resultMessage" style="font-size: 1.2rem; color: #64748b; margin: 30px 0;"></p>
                
                <div id="certificateSection" style="display: none;">
                    <div class="certificate-preview">
                        <canvas id="certificateCanvas" width="800" height="600"></canvas>
                    </div>
                    
                    <button class="btn btn-primary" onclick="downloadCertificate()" style="margin-top: 30px;">
                        <span>Download Certificate</span>
                        <span>📄</span>
                    </button>
                </div>
                
                <div id="retrySection" style="display: none;">
                    <p style="margin: 30px 0; color: #64748b; font-size: 1.1rem;">
                        You need to score 8 or above to pass. Please watch the training video again and retake the assessment.
                    </p>
                    <button class="btn btn-primary" onclick="retryAssessment()">
                        <span>Watch Video Again</span>
                        <span>🔄</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        
        // Security: Disable console
        (function() {
            const noop = function() {};
            ['log', 'debug', 'info', 'warn', 'error', 'assert', 'dir', 'dirxml', 'group',
             'groupEnd', 'time', 'timeEnd', 'count', 'trace', 'profile', 'profileEnd'].forEach(function(method) {
                window.console[method] = noop;
            });
        })();

        // Supabase configuration
        const SUPABASE_URL = 'https://wruxmwwxledjdyrkgdde.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndydXhtd3d4bGVkamR5cmtnZGRlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MjcyODE2NCwiZXhwIjoyMDY4MzA0MTY0fQ.u-7uEohwt7-VuP9grA34GIvnLBnPdyUeZaOTImc9Zh4';

        // Security: Anti-tampering
        Object.freeze(Object.prototype);
        Object.freeze(Object);
        Object.freeze(Function.prototype);

        // Global state with encryption
        let currentUser = null;
        let sessionId = null;
        let attempts = 0;
        let sessionToken = null;
        let sessionStartTime = null;
        let securityEvents = [];

        // Generate session token
        function generateSessionToken() {
            return btoa(Date.now() + Math.random().toString(36).substring(2, 15));
        }

        // Encrypt sensitive data
        function encrypt(data) {
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }

        function decrypt(data) {
            try {
                return JSON.parse(decodeURIComponent(atob(data)));
            } catch {
                return null;
            }
        }

        // Create animated particles
        function createParticles() {
            const container = document.getElementById('particlesContainer');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // Enhanced security monitoring
        function setupEnhancedSecurity() {
            // Prevent right-click
            document.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                logSecurityEvent('RIGHT_CLICK');
                showSecurityWarning('Right-click is disabled during assessment');
                return false;
            });

            // Prevent text selection
            document.addEventListener('selectstart', (e) => {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    return false;
                }
            });

            // Prevent copy/paste
            document.addEventListener('copy', (e) => {
                e.preventDefault();
                logSecurityEvent('COPY_ATTEMPT');
                showSecurityWarning('Copying is disabled during assessment');
                return false;
            });

            document.addEventListener('paste', (e) => {
                e.preventDefault();
                logSecurityEvent('PASTE_ATTEMPT');
                return false;
            });

            // Monitor tab visibility
            let hiddenTime = 0;
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    hiddenTime = Date.now();
                    logSecurityEvent('TAB_HIDDEN');
                    showSecurityWarning('Please stay on this tab during the assessment');
                } else if (hiddenTime) {
                    const duration = Date.now() - hiddenTime;
                    logSecurityEvent('TAB_VISIBLE', { duration });
                    hiddenTime = 0;
                }
            });

            // Prevent print
            window.addEventListener('beforeprint', (e) => {
                e.preventDefault();
                logSecurityEvent('PRINT_ATTEMPT');
                showSecurityWarning('Printing is disabled during assessment');
                return false;
            });

            // Advanced developer tools detection
            let devtools = { open: false, orientation: null };
            const threshold = 160;
            const emitEvent = (state, orientation) => {
                if (state) {
                    logSecurityEvent('DEVTOOLS_OPEN');
                    showSecurityWarning('Developer tools detected - Assessment may be terminated');
                }
            };

            setInterval(() => {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools.open) {
                        emitEvent(true, null);
                        devtools.open = true;
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);

            // Disable function keys and shortcuts
            document.addEventListener('keydown', (e) => {
                // Disable F1-F12
                if (e.keyCode >= 112 && e.keyCode <= 123) {
                    e.preventDefault();
                    logSecurityEvent('FUNCTION_KEY', { key: e.keyCode });
                    return false;
                }
                
                // Disable Ctrl/Cmd combinations
                if (e.ctrlKey || e.metaKey) {
                    const blockedKeys = ['a', 'c', 'v', 'x', 's', 'o', 'p', 'f', 'g', 'h', 'j', 'k', 'l', 'i', 'u'];
                    if (blockedKeys.includes(e.key.toLowerCase())) {
                        e.preventDefault();
                        logSecurityEvent('KEYBOARD_SHORTCUT', { key: e.key });
                        return false;
                    }
                }
                
                // Disable Shift+F10 (right-click menu)
                if (e.shiftKey && e.keyCode === 121) {
                    e.preventDefault();
                    return false;
                }
            });

            // Monitor window blur (possible screenshot)
            window.addEventListener('blur', () => {
                logSecurityEvent('WINDOW_BLUR');
            });

            // Detect browser extensions (basic)
            setTimeout(() => {
                const testElement = document.createElement('div');
                testElement.id = 'adblock-test';
                testElement.style.display = 'none';
                document.body.appendChild(testElement);
                
                setTimeout(() => {
                    if (!document.getElementById('adblock-test')) {
                        logSecurityEvent('EXTENSION_DETECTED');
                    } else {
                        document.body.removeChild(testElement);
                    }
                }, 100);
            }, 1000);

            // Session timeout (30 minutes)
            setTimeout(() => {
                if (sessionStartTime) {
                    alert('Session expired. Please start again.');
                    window.location.reload();
                }
            }, 30 * 60 * 1000);
        }

        function logSecurityEvent(type, details = {}) {
            const event = {
                type,
                timestamp: Date.now(),
                details,
                sessionToken
            };
            securityEvents.push(event);
            
            // Send to server if critical
            if (['DEVTOOLS_OPEN', 'TAB_HIDDEN', 'EXTENSION_DETECTED'].includes(type)) {
                sendSecurityAlert(event);
            }
        }

        async function sendSecurityAlert(event) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/security_events`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        event_type: event.type,
                        event_data: event,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (error) {
                // Silent fail
            }
        }

        function showSecurityWarning(message) {
            const warning = document.getElementById('securityWarning');
            warning.textContent = `⚠️ ${message}`;
            warning.style.display = 'block';
            setTimeout(() => {
                warning.style.display = 'none';
            }, 3000);
        }

        // Enhanced question shuffling with crypto
        function secureShuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const randomBuffer = new Uint32Array(1);
                crypto.getRandomValues(randomBuffer);
                const j = randomBuffer[0] % (i + 1);
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Questions data
        const questions = [
            {
                question: "What is the most effective way to create a strong password?",
                options: [
                    "Use your birthday and name",
                    "Use a combination of uppercase, lowercase, numbers, and symbols",
                    "Use the same password for all accounts",
                    "Write it down and keep it under your keyboard"
                ],
                correct: 1
            },
            {
                question: "What should you do if you receive a suspicious email asking for personal information?",
                options: [
                    "Reply with the requested information",
                    "Click on all links to investigate",
                    "Delete it and report it to IT security",
                    "Forward it to your colleagues"
                ],
                correct: 2
            },
            {
                question: "What is phishing?",
                options: [
                    "A type of computer virus",
                    "A fraudulent attempt to obtain sensitive information by disguising as a trustworthy entity",
                    "A method of fishing using technology",
                    "A type of firewall"
                ],
                correct: 1
            },
            {
                question: "How often should you update your passwords?",
                options: [
                    "Never, if it's strong enough",
                    "Only when forced by the system",
                    "Every 3-6 months or when compromised",
                    "Once a year"
                ],
                correct: 2
            },
            {
                question: "What is two-factor authentication (2FA)?",
                options: [
                    "Using two different passwords",
                    "An extra layer of security requiring two different authentication methods",
                    "Logging in from two different devices",
                    "Having two email addresses"
                ],
                correct: 1
            },
            {
                question: "Which of the following is a sign of a secure website?",
                options: [
                    "It has colorful graphics",
                    "The URL starts with 'https://' and shows a padlock icon",
                    "It loads quickly",
                    "It has many advertisements"
                ],
                correct: 1
            },
            {
                question: "What should you do before clicking on a link in an email?",
                options: [
                    "Click immediately if it looks interesting",
                    "Hover over it to see the actual destination URL",
                    "Forward it to friends first",
                    "Save it for later"
                ],
                correct: 1
            },
            {
                question: "What is social engineering in cybersecurity?",
                options: [
                    "Building social networks",
                    "Manipulating people to divulge confidential information",
                    "Engineering social media platforms",
                    "Creating social profiles"
                ],
                correct: 1
            },
            {
                question: "What should you do with sensitive data on a device before disposal?",
                options: [
                    "Delete all files",
                    "Format the drive",
                    "Securely wipe or physically destroy the storage",
                    "Give it to someone else to handle"
                ],
                correct: 2
            },
            {
                question: "Which is the best practice for using public WiFi?",
                options: [
                    "Connect to any available network",
                    "Use a VPN and avoid sensitive transactions",
                    "Share your hotspot password with others",
                    "Save passwords for automatic login"
                ],
                correct: 1
            }
        ];

        // Enhanced Assessment class with security
        class SecureAssessment {
            constructor(type) {
                this.type = type;
                this.currentQuestion = 0;
                this.answers = [];
                this.startTime = Date.now();
                this.questionOrder = secureShuffleArray([...Array(questions.length).keys()]);
                this.container = type === 'pre' ? 'preQuestionContainer' : 'postQuestionContainer';
                this.progressBar = type === 'pre' ? 'preProgress' : 'postProgress';
                this.nextBtn = type === 'pre' ? 'preNextBtn' : 'postNextBtn';
                this.prevBtn = type === 'pre' ? 'prePrevBtn' : 'postPrevBtn';
                this.questionTimes = [];
                this.currentQuestionStartTime = null;
            }

            start() {
                this.currentQuestion = 0;
                this.answers = [];
                this.startTime = Date.now();
                this.displayQuestion();
                sessionStartTime = Date.now();
            }

            displayQuestion() {
                const container = document.getElementById(this.container);
                const questionIndex = this.questionOrder[this.currentQuestion];
                const question = questions[questionIndex];
                
                // Track time spent on each question
                if (this.currentQuestionStartTime) {
                    this.questionTimes.push(Date.now() - this.currentQuestionStartTime);
                }
                this.currentQuestionStartTime = Date.now();
                
                // Shuffle options
                const optionOrder = secureShuffleArray([0, 1, 2, 3]);
                
                container.innerHTML = `
                    <div class="question-container">
                        <div class="question">
                            ${this.currentQuestion + 1}. ${this.sanitizeHTML(question.question)}
                        </div>
                        <div class="options">
                            ${optionOrder.map((optIndex) => `
                                <label class="option" data-index="${optIndex}">
                                    <input type="radio" name="q${this.currentQuestion}" value="${optIndex}" style="display: none;">
                                    ${this.sanitizeHTML(question.options[optIndex])}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Add click handlers with animation
                container.querySelectorAll('.option').forEach(option => {
                    option.addEventListener('click', function() {
                        container.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        this.querySelector('input').checked = true;
                    });
                });

                // Restore previous answer if any
                if (this.answers[this.currentQuestion] !== undefined) {
                    const selectedOption = container.querySelector(`input[value="${this.answers[this.currentQuestion]}"]`);
                    if (selectedOption) {
                        selectedOption.checked = true;
                        selectedOption.closest('.option').classList.add('selected');
                    }
                }

                this.updateProgress();
                this.updateButtons();
            }

            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            saveAnswer() {
                const selected = document.querySelector(`input[name="q${this.currentQuestion}"]:checked`);
                if (selected) {
                    this.answers[this.currentQuestion] = parseInt(selected.value);
                }
            }

            nextQuestion() {
                this.saveAnswer();
                
                if (this.answers[this.currentQuestion] === undefined) {
                    showError(`${this.type}Error`, 'Please select an answer before proceeding');
                    return;
                }
                
                if (this.currentQuestion < questions.length - 1) {
                    this.currentQuestion++;
                    this.displayQuestion();
                } else {
                    this.finish();
                }
            }

            previousQuestion() {
                this.saveAnswer();
                if (this.currentQuestion > 0) {
                    this.currentQuestion--;
                    this.displayQuestion();
                }
            }

            updateProgress() {
                const progress = ((this.currentQuestion + 1) / questions.length) * 100;
                document.getElementById(this.progressBar).style.width = progress + '%';
            }

            updateButtons() {
                const prevBtn = document.getElementById(this.prevBtn);
                const nextBtn = document.getElementById(this.nextBtn);
                
                prevBtn.disabled = this.currentQuestion === 0;
                
                if (this.currentQuestion === questions.length - 1) {
                    nextBtn.innerHTML = 'Finish →';
                } else {
                    nextBtn.innerHTML = 'Next →';
                }
            }

            calculateScore() {
                let correct = 0;
                this.answers.forEach((answer, index) => {
                    const questionIndex = this.questionOrder[index];
                    if (answer === questions[questionIndex].correct) {
                        correct++;
                    }
                });
                return correct;
            }

            async finish() {
                this.saveAnswer();
                
                // Track final question time
                if (this.currentQuestionStartTime) {
                    this.questionTimes.push(Date.now() - this.currentQuestionStartTime);
                }
                
                // Check if all questions answered
                if (this.answers.length < questions.length || this.answers.includes(undefined)) {
                    showError(`${this.type}Error`, 'Please answer all questions before finishing');
                    return;
                }

                const score = this.calculateScore();
                const totalTime = Math.floor((Date.now() - this.startTime) / 1000);
                
                // Check for suspicious behavior (too fast)
                if (totalTime < 30) { // Less than 30 seconds
                    logSecurityEvent('SUSPICIOUS_SPEED', { time: totalTime });
                }
                
                // Save to Supabase with encryption
                await this.saveResults(score, totalTime);
                
                if (this.type === 'pre') {
                    showPage('videoPage');
                } else {
                    showResults(score);
                }
            }

            async saveResults(score, totalTime) {
                try {
                    showLoading();
                    
                    const encryptedData = encrypt({
                        sessionId,
                        score,
                        totalTime,
                        questionTimes: this.questionTimes,
                        securityEvents: securityEvents.length
                    });
                    
                    // Save responses first
                    const responses = this.answers.map((answer, index) => ({
                        session_id: sessionId,
                        question_index: this.questionOrder[index],
                        selected_answer: answer,
                        is_correct: answer === questions[this.questionOrder[index]].correct,
                        time_spent: this.questionTimes[index] ? Math.floor(this.questionTimes[index] / 1000) : null
                    }));

                    await fetch(`${SUPABASE_URL}/rest/v1/${this.type}_test_responses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify(responses)
                    });
                    
                    // Update session
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/assessment_sessions?id=eq.${sessionId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            [`${this.type}_test_score`]: score,
                            [`${this.type}_test_time`]: totalTime,
                            [`${this.type}_test_data`]: encryptedData,
                            status: this.type === 'pre' ? 'pre_test_completed' : 'post_test_completed',
                            security_events_count: securityEvents.length
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save results');
                    }
                } catch (error) {
                    showError(`${this.type}Error`, 'Failed to save results. Please try again.');
                    throw error;
                } finally {
                    hideLoading();
                }
            }
        }

        // Initialize assessments
        const preAssessment = new SecureAssessment('pre');
        const postAssessment = new SecureAssessment('post');

        // Load designations on page load
        window.addEventListener('DOMContentLoaded', function() {
            createParticles();
            loadDesignations();
            setupEnhancedSecurity();
            sessionToken = generateSessionToken();
        });

        // Load designations from database
        async function loadDesignations() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/designations?is_active=eq.true&order=name.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const designations = await response.json();
                    const select = document.getElementById('designation');
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">Select Designation</option>';
                    
                    // Add designations from database
                    designations.forEach(des => {
                        const option = document.createElement('option');
                        option.value = des.name;
                        option.textContent = des.name;
                        select.appendChild(option);
                    });
                    
                    // Add "Other" option at the end
                    const otherOption = document.createElement('option');
                    otherOption.value = 'Other';
                    otherOption.textContent = 'Other';
                    select.appendChild(otherOption);
                }
            } catch (error) {
                // Fallback to default designations
                const defaultDesignations = [
                    'Doctor', 'Nurse', 'Administrator', 'IT Staff', 
                    'Finance Officer', 'HR Manager', 'Lab Technician', 
                    'Pharmacist', 'Other'
                ];
                
                const select = document.getElementById('designation');
                defaultDesignations.forEach(des => {
                    const option = document.createElement('option');
                    option.value = des;
                    option.textContent = des;
                    select.appendChild(option);
                });
            }
        }

        // Handle designation change - make it global
        window.handleDesignationChange = function() {
            const designation = document.getElementById('designation').value;
            const otherGroup = document.getElementById('otherDesignationGroup');
            const otherInput = document.getElementById('otherDesignation');
            
            if (designation === 'Other') {
                otherGroup.style.display = 'block';
                otherInput.required = true;
            } else {
                otherGroup.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        // Registration form handler with enhanced validation
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const designation = document.getElementById('designation').value;
            const otherDesignation = document.getElementById('otherDesignation').value.trim();
            
            // Input validation with sanitization
            const formData = {
                firstName: sanitizeInput(document.getElementById('firstName').value.trim()),
                lastName: sanitizeInput(document.getElementById('lastName').value.trim()),
                employeeId: sanitizeInput(document.getElementById('employeeId').value.trim()),
                designation: designation === 'Other' ? sanitizeInput(otherDesignation) : designation,
                designationIsManual: designation === 'Other',
                email: document.getElementById('email').value.trim().toLowerCase()
            };

            // Enhanced validation
            if (!formData.firstName || !formData.lastName || !formData.employeeId || 
                !formData.designation || !formData.email) {
                showError('regError', 'Please fill all required fields');
                return;
            }

            if (designation === 'Other' && !otherDesignation) {
                showError('regError', 'Please specify your designation');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) {
                showError('regError', 'Please enter a valid email address');
                return;
            }

            // Employee ID validation
            if (formData.employeeId.length < 3) {
                showError('regError', 'Please enter a valid employee ID');
                return;
            }

            try {
                showLoading();
                
                // Generate unique session ID
                const sessionUUID = generateUUID();
                
                // Create user in Supabase with rate limiting check
                const userResponse = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        email: formData.email,
                        full_name: `${formData.firstName} ${formData.lastName}`,
                        employee_id: formData.employeeId,
                        designation: formData.designation,
                        designation_is_manual: formData.designationIsManual,
                        registration_ip: await getClientIP(),
                        registration_timestamp: new Date().toISOString()
                    })
                });

                if (!userResponse.ok) {
                    const error = await userResponse.json();
                    if (error.message && error.message.includes('duplicate')) {
                        throw new Error('This email or employee ID is already registered');
                    }
                    throw new Error('Failed to create user account');
                }

                const userData = await userResponse.json();
                currentUser = userData[0];

                // Create assessment session
                const sessionResponse = await fetch(`${SUPABASE_URL}/rest/v1/assessment_sessions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        id: sessionUUID,
                        user_id: currentUser.id,
                        status: 'started',
                        session_type: 'initial',
                        session_token: sessionToken,
                        client_info: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language,
                            screenResolution: `${screen.width}x${screen.height}`
                        }
                    })
                });

                if (!sessionResponse.ok) {
                    throw new Error('Failed to create assessment session');
                }

                const sessionData = await sessionResponse.json();
                sessionId = sessionData[0].id;

                // Clear form data from memory
                document.getElementById('registrationForm').reset();

                // Start pre-assessment
                showPage('preAssessmentPage');
                preAssessment.start();

            } catch (error) {
                showError('regError', error.message || 'Registration failed. Please try again.');
            } finally {
                hideLoading();
            }
        });

        // Input sanitization
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML.substring(0, 100); // Limit length
        }

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Get client IP (server-side verification required)
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }

        // Enhanced video page logic with tracking
        const video = document.getElementById('trainingVideo');
        const continueBtn = document.getElementById('continueToPost');
        let videoWatched = false;
        let videoStartTime = null;
        let videoPauses = 0;
        let videoSkips = 0;

        video.addEventListener('loadedmetadata', function() {
            videoStartTime = Date.now();
        });

        video.addEventListener('pause', function() {
            if (!video.ended && video.currentTime < video.duration * 0.9) {
                videoPauses++;
                logSecurityEvent('VIDEO_PAUSE', { time: video.currentTime });
            }
        });

        video.addEventListener('seeked', function() {
            videoSkips++;
            logSecurityEvent('VIDEO_SKIP', { from: video.currentTime });
        });

        video.addEventListener('timeupdate', function() {
            const percent = (video.currentTime / video.duration) * 100;
            document.getElementById('videoPercent').textContent = Math.round(percent);
            document.getElementById('videoProgress').style.width = percent + '%';
            
            // Enable continue button when 90% watched
            if (percent >= 90 && !videoWatched) {
                videoWatched = true;
                continueBtn.disabled = false;
                
                // Update session status
                fetch(`${SUPABASE_URL}/rest/v1/assessment_sessions?id=eq.${sessionId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'video_watched',
                        video_stats: encrypt({
                            duration: video.duration,
                            watchTime: Date.now() - videoStartTime,
                            pauses: videoPauses,
                            skips: videoSkips
                        })
                    })
                });

                // Save video progress
                fetch(`${SUPABASE_URL}/rest/v1/video_progress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        video_url: video.querySelector('source').src,
                        total_duration_seconds: video.duration,
                        watched_duration_seconds: video.currentTime,
                        completed: true,
                        pauses_count: videoPauses,
                        skips_count: videoSkips,
                        completed_at: new Date().toISOString()
                    })
                });
            }
        });

        // Prevent video download
        video.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });

        continueBtn.addEventListener('click', function() {
            if (!videoWatched) {
                showError('videoError', 'Please watch at least 90% of the video');
                return;
            }
            showPage('postAssessmentPage');
            postAssessment.start();
        });

        // Results and certificate generation
        async function showResults(score) {
            showPage('resultsPage');
            
            const passed = score >= 8;
            const scoreDisplay = document.getElementById('scoreDisplay');
            const resultMessage = document.getElementById('resultMessage');
            const certificateSection = document.getElementById('certificateSection');
            const retrySection = document.getElementById('retrySection');
            
            scoreDisplay.textContent = `${score}/10`;
            scoreDisplay.className = `score-display ${passed ? 'score-pass' : 'score-fail'}`;
            
            if (passed) {
                resultMessage.textContent = 'Congratulations! You have successfully passed the cybersecurity awareness assessment.';
                certificateSection.style.display = 'block';
                retrySection.style.display = 'none';
                
                // Generate certificate with security features
                generateSecureCertificate();
                
                // Update session status
                const certificateId = `CERT-${Date.now()}-${generateUUID().substring(0, 8)}`;
                await fetch(`${SUPABASE_URL}/rest/v1/assessment_sessions?id=eq.${sessionId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'certified',
                        certificate_id: certificateId,
                        certificate_issued_at: new Date().toISOString(),
                        final_security_events: securityEvents.length,
                        completed_at: new Date().toISOString()
                    })
                });
            } else {
                resultMessage.textContent = `You scored ${score}/10. You need at least 8/10 to pass.`;
                certificateSection.style.display = 'none';
                retrySection.style.display = 'block';
                attempts++;
                
                // Update session status
                await fetch(`${SUPABASE_URL}/rest/v1/assessment_sessions?id=eq.${sessionId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'failed',
                        attempt_number: attempts,
                        completed_at: new Date().toISOString()
                    })
                });
            }
        }

        function generateSecureCertificate() {
            const canvas = document.getElementById('certificateCanvas');
            const ctx = canvas.getContext('2d');
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, 800, 600);
            gradient.addColorStop(0, '#f8f9fa');
            gradient.addColorStop(1, '#e9ecef');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);
            
            // Add security pattern
            ctx.globalAlpha = 0.05;
            for (let i = 0; i < 800; i += 50) {
                for (let j = 0; j < 600; j += 50) {
                    ctx.beginPath();
                    ctx.arc(i, j, 20, 0, Math.PI * 2);
                    ctx.strokeStyle = '#667eea';
                    ctx.stroke();
                }
            }
            ctx.globalAlpha = 1;
            
            // Outer border with gradient
            const borderGradient = ctx.createLinearGradient(0, 0, 800, 600);
            borderGradient.addColorStop(0, '#667eea');
            borderGradient.addColorStop(1, '#764ba2');
            ctx.strokeStyle = borderGradient;
            ctx.lineWidth = 4;
            ctx.strokeRect(20, 20, 760, 560);
            
            // Inner decorative border
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.strokeRect(40, 40, 720, 520);
            ctx.setLineDash([]);
            
            // Logo/Badge
            const centerX = 400;
            ctx.beginPath();
            ctx.arc(centerX, 100, 40, 0, Math.PI * 2);
            const logoGradient = ctx.createRadialGradient(centerX, 100, 0, centerX, 100, 40);
            logoGradient.addColorStop(0, '#667eea');
            logoGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = logoGradient;
            ctx.fill();
            
            // Shield icon in logo
            ctx.fillStyle = 'white';
            ctx.font = 'bold 30px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('🛡️', centerX, 112);
            
            // Header text with shadow
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 2;
            ctx.shadowOffsetY = 2;
            
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 36px Georgia, serif';
            ctx.textAlign = 'center';
            ctx.fillText('CERTIFICATE OF ACHIEVEMENT', centerX, 180);
            
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
            
            // Subtitle
            ctx.font = '20px Arial';
            ctx.fillStyle = '#64748b';
            ctx.fillText('Cybersecurity Awareness Training', centerX, 210);
            
            // Decorative line
            ctx.beginPath();
            ctx.moveTo(200, 230);
            ctx.lineTo(600, 230);
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // Certificate text
            ctx.font = '18px Arial';
            ctx.fillStyle = '#475569';
            ctx.fillText('This is to certify that', centerX, 280);
            
            // Name with gradient
            const nameGradient = ctx.createLinearGradient(200, 310, 600, 340);
            nameGradient.addColorStop(0, '#667eea');
            nameGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = nameGradient;
            ctx.font = 'bold 32px Georgia, serif';
            ctx.fillText(currentUser.full_name.toUpperCase(), centerX, 330);
            
            // Designation
            ctx.font = 'italic 20px Arial';
            ctx.fillStyle = '#64748b';
            ctx.fillText(currentUser.designation, centerX, 365);
            
            // Achievement text
            ctx.font = '16px Arial';
            ctx.fillStyle = '#475569';
            ctx.fillText('has successfully completed the mandatory', centerX, 410);
            ctx.fillText('Cybersecurity Awareness Training Program', centerX, 435);
            ctx.fillText('and demonstrated proficiency in security best practices', centerX, 460);
            
            // Date and Certificate ID
            const today = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            ctx.font = '14px Arial';
            ctx.fillStyle = '#64748b';
            ctx.fillText(`Issue Date: ${today}`, 200, 520);
            ctx.textAlign = 'right';
            ctx.fillText(`Certificate ID: CERT-${Date.now()}-${generateUUID().substring(0, 8)}`, 600, 520);
            
            // Digital signature
            ctx.textAlign = 'center';
            ctx.font = 'italic 16px Arial';
            ctx.fillStyle = '#475569';
            ctx.fillText('Digitally Signed and Verified', centerX, 540);
            
            // QR Code placeholder (in production, generate actual QR)
            ctx.fillStyle = '#000';
            ctx.fillRect(360, 480, 80, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 10px Arial';
            ctx.fillText('VERIFY', centerX, 525);
            
            // Watermark
            ctx.globalAlpha = 0.03;
            ctx.font = 'bold 120px Arial';
            ctx.fillStyle = '#667eea';
            ctx.save();
            ctx.translate(centerX, 350);
            ctx.rotate(-Math.PI / 6);
            ctx.fillText('CERTIFIED', 0, 0);
            ctx.restore();
            ctx.globalAlpha = 1;
        }

        window.downloadCertificate = function() {
            const canvas = document.getElementById('certificateCanvas');
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `Certificate_${currentUser.full_name.replace(/\s+/g, '_')}_${timestamp}.png`;
            
            // Add watermark with timestamp before download
            const ctx = canvas.getContext('2d');
            ctx.font = '10px Arial';
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.textAlign = 'right';
            ctx.fillText(`Downloaded: ${new Date().toLocaleString()}`, 790, 590);
            
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            
            // Log download
            logSecurityEvent('CERTIFICATE_DOWNLOAD', { 
                certificateId: `CERT-${Date.now()}`,
                timestamp: new Date().toISOString()
            });
        }

        window.retryAssessment = async function() {
            attempts++;
            
            if (attempts > 3) {
                showError('retryError', 'Maximum attempts exceeded. Please contact your administrator.');
                return;
            }
            
            // Create new session for retry
            const sessionResponse = await fetch(`${SUPABASE_URL}/rest/v1/assessment_sessions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify({
                    user_id: currentUser.id,
                    status: 'started',
                    session_type: 'retry',
                    attempt_number: attempts + 1,
                    previous_session_id: sessionId,
                    session_token: sessionToken
                })
            });

            const sessionData = await sessionResponse.json();
            sessionId = sessionData[0].id;
            
            // Reset video watched flag
            videoWatched = false;
            videoStartTime = null;
            videoPauses = 0;
            videoSkips = 0;
            document.getElementById('continueToPost').disabled = true;
            document.getElementById('videoPercent').textContent = '0';
            document.getElementById('videoProgress').style.width = '0%';
            video.currentTime = 0;
            
            // Clear security events for new attempt
            securityEvents = [];
            
            // Go back to video
            showPage('videoPage');
        }

        // Helper functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            setTimeout(() => {
                document.getElementById(pageId).classList.add('active');
            }, 100);
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // Prevent back button
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
            window.history.go(1);
        };

        // Final security: Prevent page source view
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.keyCode === 85) { // Ctrl+U
                e.preventDefault();
                logSecurityEvent('VIEW_SOURCE_ATTEMPT');
                return false;
            }
        });

        // Detect and prevent automation tools
        const detectAutomation = () => {
            const automation = window.navigator.webdriver || 
                               window.document.documentElement.getAttribute("webdriver") ||
                               window.callPhantom || window._phantom;
            
            if (automation) {
                logSecurityEvent('AUTOMATION_DETECTED');
                alert('Automated testing tools detected. This session will be terminated.');
                window.location.href = 'about:blank';
            }
        };

        setInterval(detectAutomation, 5000);

        // Monitor for multiple sessions
        const sessionKey = 'active_assessment_session';
        const currentSessionId = Date.now().toString();

        window.addEventListener('storage', (e) => {
            if (e.key === sessionKey && e.newValue && e.newValue !== currentSessionId) {
                alert('Multiple sessions detected. This session will be terminated.');
                window.location.href = 'about:blank';
            }
        });

        localStorage.setItem(sessionKey, currentSessionId);

        window.addEventListener('beforeunload', () => {
            localStorage.removeItem(sessionKey);
        });
    </script>
</body>
</html>